-- KS-Rivals Script Hub - Anti-Freeze Rebuild
-- 모든 WaitForChild 타임아웃 추가, require pcall 래핑, 동기 블로킹 제거

-- ============================================
-- SERVICES
-- ============================================
local UserInputService = game:GetService("UserInputService")
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local VirtualInputManager = game:GetService("VirtualInputManager")
local TweenService = game:GetService("TweenService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local HttpService = game:GetService("HttpService")
local LocalPlayer = Players.LocalPlayer
local Mouse = LocalPlayer:GetMouse()
local Camera = workspace.CurrentCamera

-- ============================================
-- [FIX] 안전한 WaitForChild 래퍼 (타임아웃 보장)
-- ============================================
local function SafeWait(parent, name, timeout)
    timeout = timeout or 3
    if not parent then return nil end
    local ok, result = pcall(function()
        return parent:WaitForChild(name, timeout)
    end)
    if ok then return result end
    return nil
end

-- [FIX] 안전한 require 래퍼
local function SafeRequire(module)
    if not module then return nil end
    local ok, result = pcall(require, module)
    if ok then return result end
    return nil
end

-- ============================================
-- [FIX] GUI 사전 정리
-- ============================================
pcall(function()
    for _, gui in ipairs(game:GetService("CoreGui"):GetChildren()) do
        if gui.Name == "KSRivals_Hub" then gui:Destroy() end
    end
end)
pcall(function()
    for _, gui in ipairs(LocalPlayer.PlayerGui:GetChildren()) do
        if gui.Name == "NotificationSystem" or gui.Name == "KSRivals_Hub" then
            gui:Destroy()
        end
    end
end)
pcall(function() RunService:UnbindFromRenderStep("ThirdPersonCamera") end)

-- ============================================
-- TEAM CHECK
-- ============================================
local function getTeamID(player)
    local teamID = player:GetAttribute("TeamID")
    if teamID then return teamID end
    if player.Character then
        local teamValue = player.Character:FindFirstChild("TeamID")
        if teamValue and (teamValue:IsA("StringValue") or teamValue:IsA("IntValue")) then
            return teamValue.Value
        end
    end
    if player.Team then return player.Team.Name end
    return nil
end

local function isEnemy(player)
    if not player or player == LocalPlayer then return false end
    local myTeam = getTeamID(LocalPlayer)
    local theirTeam = getTeamID(player)
    if not myTeam or not theirTeam then return false end
    return myTeam ~= theirTeam
end

-- ============================================
-- CONFIG
-- ============================================
local ESP_ENABLED = false
local SILENT_AIM_ENABLED = false
local HP_BAR_ENABLED = false
local AIM_LOCK_ENABLED = false
local AUTO_AIM_ENABLED = false
local NOTIFICATION_ENABLED = false
local AUTO_MATCH_ENABLED = false
local FULL_AUTO_ENABLED = false
local SKIN_CHANGER_ENABLED = false
local NO_COOL_TIME_ENABLED = false
local RAGE_BOT_ENABLED = false
local THIRD_PERSON_ENABLED = false
local NO_RECOIL_ENABLED = false
local AUTO_AIM_MODE = "Silent"
local AUTO_MATCH_MODE = "1v1"
local AIM_LOCK_KEY = Enum.UserInputType.MouseButton2
local RAGE_BOT_KEY = Enum.KeyCode.Five

local isAimLockHeld = false
local aimLockConnection = nil
local lastClickTime = 0
local CLICK_INTERVAL = 0.01
local LOADING_COMPLETE = false
local HUB_ANIMATION_PLAYING = false
local ToggleCheckInners = {}

local function saveConfig()
    local config = {
        ESP_ENABLED = ESP_ENABLED, SILENT_AIM_ENABLED = SILENT_AIM_ENABLED,
        HP_BAR_ENABLED = HP_BAR_ENABLED, AIM_LOCK_ENABLED = AIM_LOCK_ENABLED,
        AUTO_AIM_ENABLED = AUTO_AIM_ENABLED, NOTIFICATION_ENABLED = NOTIFICATION_ENABLED,
        AUTO_MATCH_ENABLED = AUTO_MATCH_ENABLED, FULL_AUTO_ENABLED = FULL_AUTO_ENABLED,
        SKIN_CHANGER_ENABLED = SKIN_CHANGER_ENABLED, NO_COOL_TIME_ENABLED = NO_COOL_TIME_ENABLED,
        RAGE_BOT_ENABLED = RAGE_BOT_ENABLED, THIRD_PERSON_ENABLED = THIRD_PERSON_ENABLED,
        NO_RECOIL_ENABLED = NO_RECOIL_ENABLED, AUTO_AIM_MODE = AUTO_AIM_MODE,
        AUTO_MATCH_MODE = AUTO_MATCH_MODE, AIM_LOCK_KEY = tostring(AIM_LOCK_KEY),
        RAGE_BOT_KEY = tostring(RAGE_BOT_KEY)
    }
    pcall(function() writefile("KSRivals_Config.json", HttpService:JSONEncode(config)) end)
end

-- [FIX] config 로드 시 FULL_AUTO 강제 비활성화 (프리즈 방지)
local function loadConfig()
    local ok, result = pcall(function()
        if isfile and isfile("KSRivals_Config.json") then
            return HttpService:JSONDecode(readfile("KSRivals_Config.json"))
        end
        return nil
    end)
    if ok then return result end
    return nil
end

local savedConfig = loadConfig()
if savedConfig then
    ESP_ENABLED = savedConfig.ESP_ENABLED or false
    SILENT_AIM_ENABLED = savedConfig.SILENT_AIM_ENABLED or false
    HP_BAR_ENABLED = savedConfig.HP_BAR_ENABLED or false
    AIM_LOCK_ENABLED = savedConfig.AIM_LOCK_ENABLED or false
    AUTO_AIM_ENABLED = savedConfig.AUTO_AIM_ENABLED or false
    NOTIFICATION_ENABLED = savedConfig.NOTIFICATION_ENABLED or false
    AUTO_MATCH_ENABLED = savedConfig.AUTO_MATCH_ENABLED or false
    -- [FIX] FULL_AUTO는 항상 false로 시작 (저장값 무시) - 즉시 실행 시 프리즈 원인
    FULL_AUTO_ENABLED = false
    SKIN_CHANGER_ENABLED = savedConfig.SKIN_CHANGER_ENABLED or false
    NO_COOL_TIME_ENABLED = savedConfig.NO_COOL_TIME_ENABLED or false
    RAGE_BOT_ENABLED = savedConfig.RAGE_BOT_ENABLED or false
    THIRD_PERSON_ENABLED = savedConfig.THIRD_PERSON_ENABLED or false
    NO_RECOIL_ENABLED = savedConfig.NO_RECOIL_ENABLED or false
    AUTO_AIM_MODE = savedConfig.AUTO_AIM_MODE or "Silent"
    AUTO_MATCH_MODE = savedConfig.AUTO_MATCH_MODE or "1v1"
    if savedConfig.AIM_LOCK_KEY then
        pcall(function()
            if savedConfig.AIM_LOCK_KEY:find("MouseButton") then
                AIM_LOCK_KEY = Enum.UserInputType[savedConfig.AIM_LOCK_KEY:split(".")[3]]
            else
                AIM_LOCK_KEY = Enum.KeyCode[savedConfig.AIM_LOCK_KEY:split(".")[3]]
            end
        end)
    end
    if savedConfig.RAGE_BOT_KEY then
        pcall(function()
            RAGE_BOT_KEY = Enum.KeyCode[savedConfig.RAGE_BOT_KEY:split(".")[3]]
        end)
    end
end

-- ============================================
-- AUTO-RELOAD
-- ============================================
local SCRIPT_URL = "https://raw.githubusercontent.com/Supporters-key091239/-/refs/heads/main/%E2%94%8A%E2%95%98%E2%95%9B%E2%96%89%F0%9F%82%A8%E2%94%A7"
local BOOTSTRAP_CODE = [[
repeat task.wait() until game:IsLoaded()
task.wait(2)
pcall(function()
    loadstring(game:HttpGet("]] .. SCRIPT_URL .. [[", true))()
end)
]]

local function setupAutoReload()
    local qot = syn and syn.queue_on_teleport or queue_on_teleport or queueonteleport
    if qot then pcall(function() qot(BOOTSTRAP_CODE) end) end
end
setupAutoReload()
LocalPlayer.OnTeleport:Connect(function(state)
    if state == Enum.TeleportState.Started then saveConfig() setupAutoReload() end
end)

-- ============================================
-- NOTIFICATION SYSTEM
-- ============================================
local NotificationGui = Instance.new("ScreenGui")
NotificationGui.Name = "NotificationSystem"
NotificationGui.Parent = LocalPlayer.PlayerGui
NotificationGui.ResetOnSpawn = false

local NotifContainer = Instance.new("Frame")
NotifContainer.Size = UDim2.new(0, 200, 0, 400)
NotifContainer.Position = UDim2.new(0, 10, 0, 10)
NotifContainer.BackgroundTransparency = 1
NotifContainer.Parent = NotificationGui

local NotifLayout = Instance.new("UIListLayout")
NotifLayout.SortOrder = Enum.SortOrder.LayoutOrder
NotifLayout.Padding = UDim.new(0, 4)
NotifLayout.Parent = NotifContainer

local function createNotification(text)
    if not NOTIFICATION_ENABLED then return end
    local notif = Instance.new("Frame")
    notif.Size = UDim2.new(0, 0, 0, 22)
    notif.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
    notif.BackgroundTransparency = 0.2
    notif.BorderSizePixel = 0
    notif.ClipsDescendants = true
    notif.Parent = NotifContainer
    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0, 4)
    corner.Parent = notif
    local label = Instance.new("TextLabel")
    label.Size = UDim2.new(1, -10, 1, 0)
    label.Position = UDim2.new(0, 5, 0, 0)
    label.BackgroundTransparency = 1
    label.Text = text
    label.TextColor3 = Color3.fromRGB(255, 255, 255)
    label.TextSize = 12
    label.Font = Enum.Font.GothamBold
    label.TextXAlignment = Enum.TextXAlignment.Left
    label.Parent = notif
    TweenService:Create(notif, TweenInfo.new(0.3, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {Size = UDim2.new(1, 0, 0, 22)}):Play()
    task.delay(2, function()
        if notif and notif.Parent then
            local t = TweenService:Create(notif, TweenInfo.new(0.3, Enum.EasingStyle.Quad, Enum.EasingDirection.In), {Size = UDim2.new(0, 0, 0, 22)})
            t:Play()
            t.Completed:Connect(function() if notif then notif:Destroy() end end)
        end
    end)
end

-- ============================================
-- SILENT AIM
-- [FIX] 메타테이블 훅을 task.spawn으로 비동기 처리
-- ============================================
local metaTableHooked = false
local oldNamecall = nil

local function isVisible(targetHead)
    if not targetHead then return false end
    local character = LocalPlayer.Character
    if not character then return false end
    local rayParams = RaycastParams.new()
    rayParams.FilterDescendantsInstances = {character}
    rayParams.FilterType = Enum.RaycastFilterType.Exclude
    local origin = Camera.CFrame.Position
    local ray = workspace:Raycast(origin, targetHead.Position - origin, rayParams)
    if not ray then return true end
    return ray.Instance:IsDescendantOf(targetHead.Parent)
end

local function getClosestPlayerForSilentAim()
    if not SILENT_AIM_ENABLED then return nil end
    local character = LocalPlayer.Character
    if not character or not character:FindFirstChild("HumanoidRootPart") then return nil end
    local closestPlayer = nil
    local shortestDist = math.huge
    local screenCenter = Vector2.new(Camera.ViewportSize.X / 2, Camera.ViewportSize.Y / 2)
    for _, player in ipairs(Players:GetPlayers()) do
        if player ~= LocalPlayer and isEnemy(player) and player.Character then
            local head = player.Character:FindFirstChild("Head")
            local hum = player.Character:FindFirstChild("Humanoid")
            if head and hum and hum.Health > 0 then
                local sp, onScreen = Camera:WorldToScreenPoint(head.Position)
                if onScreen and isVisible(head) then
                    local d = (Vector2.new(sp.X, sp.Y) - screenCenter).Magnitude
                    if d < shortestDist then shortestDist = d; closestPlayer = player end
                end
            end
        end
    end
    return closestPlayer
end

local function createFakeRaycastResult(targetHead, rayOrigin)
    if not targetHead then return nil end
    local dir = (targetHead.Position - rayOrigin).Unit
    return {
        Instance = targetHead, Position = targetHead.Position,
        Distance = (targetHead.Position - rayOrigin).Magnitude,
        Material = targetHead.Material, Normal = -dir,
    }
end

local function shouldHookRaycast(origin, direction, rp)
    if not SILENT_AIM_ENABLED then return false end
    if not rp then return false end
    if rp.FilterType ~= Enum.RaycastFilterType.Include then return false end
    if direction.Magnitude < 10 then return false end
    if (origin - Camera.CFrame.Position).Magnitude > 5 then return false end
    return true
end

-- [FIX] 메타테이블 훅을 task.spawn으로 분리하여 메인 스레드 블로킹 방지
task.spawn(function()
    if metaTableHooked then return end
    local ok, mt = pcall(getrawmetatable, game)
    if not ok or not mt then return end

    local orig = mt.__namecall
    if not orig then return end
    oldNamecall = orig

    local writeOk = pcall(setreadonly, mt, false)
    if not writeOk then pcall(function() make_writeable(mt) end) end

    local hookFn = function(self, ...)
        local method = getnamecallmethod()
        if method == "Raycast" and self == workspace then
            local args = {...}
            if shouldHookRaycast(args[1], args[2], args[3]) then
                local cp = getClosestPlayerForSilentAim()
                if cp and cp.Character then
                    local head = cp.Character:FindFirstChild("Head")
                    if head then return createFakeRaycastResult(head, args[1]) end
                end
                return nil
            end
        end
        return orig(self, ...)
    end

    local hookSet = pcall(function()
        mt.__namecall = newcclosure and newcclosure(hookFn) or hookFn
    end)

    pcall(setreadonly, mt, true)
    pcall(function() make_readonly(mt) end)

    if hookSet then metaTableHooked = true end
end)

-- ============================================
-- UI SETUP
-- ============================================
local KSRivals = Instance.new("ScreenGui")
KSRivals.Name = "KSRivals_Hub"
KSRivals.ResetOnSpawn = false
pcall(function() KSRivals.Parent = game:GetService("CoreGui") end)
if not KSRivals.Parent then KSRivals.Parent = LocalPlayer.PlayerGui end

local MainFrame = Instance.new("Frame")
MainFrame.Name = "MainFrame"
MainFrame.Parent = KSRivals
MainFrame.BackgroundColor3 = Color3.fromRGB(8, 8, 8)
MainFrame.Position = UDim2.new(0.5, -240, 0.5, -160)
MainFrame.Size = UDim2.new(0, 480, 0, 320)
MainFrame.BorderSizePixel = 0
MainFrame.Visible = false
MainFrame.ClipsDescendants = true

local MainStroke = Instance.new("UIStroke")
MainStroke.Color = Color3.fromRGB(255, 255, 255)
MainStroke.Thickness = 1
MainStroke.Parent = MainFrame

-- KEYBIND INFO
local KeybindInfoFrame = Instance.new("Frame")
KeybindInfoFrame.Name = "KeybindInfoFrame"
KeybindInfoFrame.Parent = KSRivals
KeybindInfoFrame.BackgroundColor3 = Color3.fromRGB(8, 8, 8)
KeybindInfoFrame.BackgroundTransparency = 0.3
KeybindInfoFrame.Position = UDim2.new(1, -180, 0.5, -50)
KeybindInfoFrame.Size = UDim2.new(0, 170, 0, 100)
KeybindInfoFrame.BorderSizePixel = 0
KeybindInfoFrame.Visible = false
KeybindInfoFrame.ClipsDescendants = true

local KeybindStroke = Instance.new("UIStroke")
KeybindStroke.Color = Color3.fromRGB(255, 255, 255)
KeybindStroke.Thickness = 1
KeybindStroke.Transparency = 0.3
KeybindStroke.Parent = KeybindInfoFrame

local KeybindCorner = Instance.new("UICorner")
KeybindCorner.CornerRadius = UDim.new(0, 4)
KeybindCorner.Parent = KeybindInfoFrame

local KeybindTitle = Instance.new("TextLabel")
KeybindTitle.Parent = KeybindInfoFrame
KeybindTitle.BackgroundTransparency = 1
KeybindTitle.Position = UDim2.new(0, 10, 0, 8)
KeybindTitle.Size = UDim2.new(1, -20, 0, 16)
KeybindTitle.Font = Enum.Font.GothamBold
KeybindTitle.Text = "KEYBINDS"
KeybindTitle.TextColor3 = Color3.fromRGB(255, 255, 255)
KeybindTitle.TextSize = 12
KeybindTitle.TextXAlignment = Enum.TextXAlignment.Left

local KeybindInfo = Instance.new("TextLabel")
KeybindInfo.Parent = KeybindInfoFrame
KeybindInfo.BackgroundTransparency = 1
KeybindInfo.Position = UDim2.new(0, 10, 0, 28)
KeybindInfo.Size = UDim2.new(1, -20, 1, -36)
KeybindInfo.Font = Enum.Font.Code
KeybindInfo.Text = ""
KeybindInfo.TextColor3 = Color3.fromRGB(200, 200, 200)
KeybindInfo.TextSize = 11
KeybindInfo.TextXAlignment = Enum.TextXAlignment.Left
KeybindInfo.TextYAlignment = Enum.TextYAlignment.Top
KeybindInfo.TextWrapped = true

local function formatKeyName(e)
    local n = e.Name
    if n == "MouseButton1" then return "MB1" end
    if n == "MouseButton2" then return "MB2" end
    return n
end

local function UpdateKeybindInfo()
    local lines = {"Hub Toggle: [K]"}
    if AIM_LOCK_ENABLED then table.insert(lines, "Aim Lock: [" .. formatKeyName(AIM_LOCK_KEY) .. "]") end
    if RAGE_BOT_ENABLED then table.insert(lines, "Rage Bot: [" .. formatKeyName(RAGE_BOT_KEY) .. "]") end
    KeybindInfo.Text = table.concat(lines, "\n")
    local h = (#lines * 15) + 30
    KeybindInfoFrame.Size = UDim2.new(0, 170, 0, h)
    KeybindInfoFrame.Position = UDim2.new(1, -180, 0.5, -h/2)
end

local KEYBIND_ANIM = false
local function ShowKeybindInfo()
    if KEYBIND_ANIM or MainFrame.Visible then return end
    KEYBIND_ANIM = true
    UpdateKeybindInfo()
    local h = KeybindInfoFrame.Size.Y.Offset
    KeybindInfoFrame.Size = UDim2.new(0, 0, 0, h)
    KeybindInfoFrame.Position = UDim2.new(1, 0, 0.5, -h/2)
    KeybindInfoFrame.BackgroundTransparency = 1
    KeybindStroke.Transparency = 1
    KeybindTitle.TextTransparency = 1
    KeybindInfo.TextTransparency = 1
    KeybindInfoFrame.Visible = true
    local t = TweenService:Create(KeybindInfoFrame, TweenInfo.new(0.3, Enum.EasingStyle.Quart, Enum.EasingDirection.Out), {
        Size = UDim2.new(0, 170, 0, h), Position = UDim2.new(1, -180, 0.5, -h/2), BackgroundTransparency = 0.3
    })
    TweenService:Create(KeybindStroke, TweenInfo.new(0.3, Enum.EasingStyle.Quart, Enum.EasingDirection.Out), {Transparency = 0.3}):Play()
    t:Play()
    t.Completed:Connect(function()
        TweenService:Create(KeybindTitle, TweenInfo.new(0.2), {TextTransparency = 0}):Play()
        TweenService:Create(KeybindInfo, TweenInfo.new(0.2), {TextTransparency = 0.2}):Play()
        task.wait(0.2)
        KEYBIND_ANIM = false
    end)
end

local function HideKeybindInfo()
    if KEYBIND_ANIM then return end
    KEYBIND_ANIM = true
    TweenService:Create(KeybindTitle, TweenInfo.new(0.15), {TextTransparency = 1}):Play()
    TweenService:Create(KeybindInfo, TweenInfo.new(0.15), {TextTransparency = 1}):Play()
    task.wait(0.15)
    local h = KeybindInfoFrame.Size.Y.Offset
    local t = TweenService:Create(KeybindInfoFrame, TweenInfo.new(0.25, Enum.EasingStyle.Quart, Enum.EasingDirection.In), {
        Size = UDim2.new(0, 0, 0, h), Position = UDim2.new(1, 0, 0.5, -h/2), BackgroundTransparency = 1
    })
    TweenService:Create(KeybindStroke, TweenInfo.new(0.25), {Transparency = 1}):Play()
    t:Play()
    t.Completed:Connect(function()
        KeybindInfoFrame.Visible = false
        KeybindInfoFrame.BackgroundTransparency = 0.3
        KeybindStroke.Transparency = 0.3
        KEYBIND_ANIM = false
    end)
end

-- ============================================
-- LOADING UI
-- ============================================
local LoadingOverlay = Instance.new("Frame")
LoadingOverlay.Parent = MainFrame
LoadingOverlay.BackgroundColor3 = Color3.fromRGB(8, 8, 8)
LoadingOverlay.Size = UDim2.new(1, 0, 1, 0)
LoadingOverlay.ZIndex = 100
LoadingOverlay.BorderSizePixel = 0
LoadingOverlay.Visible = true

local function MakeLabel(parent, pos, size, text, textSize, font, zi)
    local l = Instance.new("TextLabel")
    l.Parent = parent
    l.BackgroundTransparency = 1
    l.Position = pos
    l.Size = size
    l.AnchorPoint = Vector2.new(0.5, 0.5)
    l.Font = font or Enum.Font.GothamBold
    l.Text = text
    l.TextColor3 = Color3.fromRGB(255, 255, 255)
    l.TextSize = textSize or 13
    l.ZIndex = zi or 101
    l.TextTransparency = 1
    return l
end

local LoadingTitle = MakeLabel(LoadingOverlay, UDim2.new(0.5,0,0.28,0), UDim2.new(0.8,0,0,35), "KS-RIVALS HUB", 24, Enum.Font.GothamBlack)
local LoadingSubtitle = MakeLabel(LoadingOverlay, UDim2.new(0.5,0,0.38,0), UDim2.new(0.8,0,0,20), "MADE BY TEAM KS", 11)
LoadingSubtitle.TextColor3 = Color3.fromRGB(100, 100, 100)

local ProgressBarBg = Instance.new("Frame")
ProgressBarBg.Parent = LoadingOverlay
ProgressBarBg.BackgroundColor3 = Color3.fromRGB(25, 25, 25)
ProgressBarBg.Position = UDim2.new(0.5, 0, 0.52, 0)
ProgressBarBg.Size = UDim2.new(0.6, 0, 0, 8)
ProgressBarBg.AnchorPoint = Vector2.new(0.5, 0.5)
ProgressBarBg.BorderSizePixel = 0
ProgressBarBg.ZIndex = 101
ProgressBarBg.BackgroundTransparency = 1
Instance.new("UICorner", ProgressBarBg).CornerRadius = UDim.new(0, 4)

local ProgressBarBgStroke = Instance.new("UIStroke")
ProgressBarBgStroke.Color = Color3.fromRGB(60, 60, 60)
ProgressBarBgStroke.Thickness = 1
ProgressBarBgStroke.Transparency = 1
ProgressBarBgStroke.Parent = ProgressBarBg

local ProgressBarFill = Instance.new("Frame")
ProgressBarFill.Parent = ProgressBarBg
ProgressBarFill.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
ProgressBarFill.Size = UDim2.new(0, 0, 1, 0)
ProgressBarFill.BorderSizePixel = 0
ProgressBarFill.ZIndex = 102
Instance.new("UICorner", ProgressBarFill).CornerRadius = UDim.new(0, 4)

local LoadingStatusText = MakeLabel(LoadingOverlay, UDim2.new(0.5,0,0.62,0), UDim2.new(0.8,0,0,22), "Initializing...", 13)
LoadingStatusText.TextColor3 = Color3.fromRGB(180, 180, 180)

local LoadingPercent = MakeLabel(LoadingOverlay, UDim2.new(0.5,0,0.72,0), UDim2.new(0.8,0,0,18), "0%", 16, Enum.Font.GothamBlack)

-- CONTENT CONTAINER
local ContentContainer = Instance.new("Frame")
ContentContainer.Parent = MainFrame
ContentContainer.BackgroundTransparency = 1
ContentContainer.Size = UDim2.new(1, 0, 1, 0)
ContentContainer.Visible = false
ContentContainer.ZIndex = 1

local TopBar = Instance.new("Frame")
TopBar.Size = UDim2.new(1, 0, 0, 25)
TopBar.BackgroundTransparency = 1
TopBar.Parent = ContentContainer

local Title = Instance.new("TextLabel")
Title.Text = "KS-Rivals HUB2 - Integrated"
Title.Font = Enum.Font.Code
Title.TextColor3 = Color3.fromRGB(255, 255, 255)
Title.TextSize = 13
Title.Size = UDim2.new(1, -60, 1, 0)
Title.Position = UDim2.new(0, 10, 0, 0)
Title.TextXAlignment = Enum.TextXAlignment.Left
Title.BackgroundTransparency = 1
Title.Parent = TopBar

local CloseBtn = Instance.new("TextButton")
CloseBtn.Size = UDim2.new(0, 25, 0, 25)
CloseBtn.Position = UDim2.new(1, -25, 0, 0)
CloseBtn.BackgroundTransparency = 1
CloseBtn.Text = "X"
CloseBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
CloseBtn.Font = Enum.Font.Code
CloseBtn.TextSize = 15
CloseBtn.Parent = TopBar

local TabContainer = Instance.new("Frame")
TabContainer.Size = UDim2.new(1, 0, 0, 30)
TabContainer.Position = UDim2.new(0, 0, 0, 25)
TabContainer.BackgroundTransparency = 1
TabContainer.Parent = ContentContainer

local function CreateTabBtn(name, pos)
    local btn = Instance.new("TextButton")
    btn.Text = "  " .. name .. "  "
    btn.Font = Enum.Font.Code
    btn.TextColor3 = Color3.fromRGB(150, 150, 150)
    btn.TextSize = 14
    btn.BackgroundTransparency = 1
    btn.Size = UDim2.new(0, 80, 1, 0)
    btn.Position = pos
    btn.Parent = TabContainer
    return btn
end

local AimTab = CreateTabBtn("main", UDim2.new(0, 0, 0, 0))
local VisualTab = CreateTabBtn("visuals", UDim2.new(0, 85, 0, 0))

local Content = Instance.new("Frame")
Content.Size = UDim2.new(1, -20, 1, -65)
Content.Position = UDim2.new(0, 10, 0, 55)
Content.BackgroundTransparency = 1
Content.Parent = ContentContainer

local AimPage = Instance.new("Frame")
AimPage.Size = UDim2.new(1, 0, 1, 0)
AimPage.BackgroundTransparency = 1
AimPage.Visible = true
AimPage.Parent = Content

local VisualPage = Instance.new("Frame")
VisualPage.Size = UDim2.new(1, 0, 1, 0)
VisualPage.BackgroundTransparency = 1
VisualPage.Visible = false
VisualPage.Parent = Content

local AimList = Instance.new("UIListLayout")
AimList.Padding = UDim.new(0, 4)
AimList.Parent = AimPage

local VisualList = Instance.new("UIListLayout")
VisualList.Padding = UDim.new(0, 4)
VisualList.Parent = VisualPage

-- ============================================
-- HELPERS
-- ============================================
local function IsToggleCheckInner(e)
    for _, v in ipairs(ToggleCheckInners) do if e == v then return true end end
    return false
end

local function ShowTab(t)
    if t == "Aim" then
        AimPage.Visible = true; VisualPage.Visible = false
        AimTab.TextColor3 = Color3.fromRGB(255,255,255)
        VisualTab.TextColor3 = Color3.fromRGB(130,130,130)
    else
        AimPage.Visible = false; VisualPage.Visible = true
        AimTab.TextColor3 = Color3.fromRGB(130,130,130)
        VisualTab.TextColor3 = Color3.fromRGB(255,255,255)
    end
end

AimTab.MouseButton1Click:Connect(function() ShowTab("Aim") end)
VisualTab.MouseButton1Click:Connect(function() ShowTab("Visual") end)

-- ============================================
-- HUB ANIMATION
-- ============================================
local function FadeContentIn()
    for _, child in ipairs(ContentContainer:GetDescendants()) do
        if IsToggleCheckInner(child) then continue end
        if child:IsA("TextLabel") or child:IsA("TextButton") then
            child.TextTransparency = 1
            TweenService:Create(child, TweenInfo.new(0.2), {TextTransparency = 0}):Play()
        end
        if child:IsA("Frame") and child.BackgroundTransparency < 1 then
            local orig = child.BackgroundTransparency
            child.BackgroundTransparency = 1
            TweenService:Create(child, TweenInfo.new(0.2), {BackgroundTransparency = orig}):Play()
        end
    end
end

local function AnimateHubOpen()
    if HUB_ANIMATION_PLAYING then return end
    HUB_ANIMATION_PLAYING = true
    HideKeybindInfo()
    MainFrame.Size = UDim2.new(0, 480, 0, 0)
    MainFrame.Position = UDim2.new(0.5, -240, 0.5, 0)
    MainFrame.BackgroundTransparency = 1
    MainStroke.Transparency = 1
    ContentContainer.Visible = false
    MainFrame.Visible = true
    local t = TweenService:Create(MainFrame, TweenInfo.new(0.25, Enum.EasingStyle.Quart, Enum.EasingDirection.Out), {
        Size = UDim2.new(0, 480, 0, 320), Position = UDim2.new(0.5, -240, 0.5, -160), BackgroundTransparency = 0
    })
    TweenService:Create(MainStroke, TweenInfo.new(0.25, Enum.EasingStyle.Quart, Enum.EasingDirection.Out), {Transparency = 0}):Play()
    t:Play()
    t.Completed:Connect(function()
        ContentContainer.Visible = true
        FadeContentIn()
        task.wait(0.2)
        HUB_ANIMATION_PLAYING = false
    end)
end

local function AnimateHubClose(callback)
    if HUB_ANIMATION_PLAYING then return end
    HUB_ANIMATION_PLAYING = true
    for _, child in ipairs(ContentContainer:GetDescendants()) do
        if IsToggleCheckInner(child) then continue end
        if child:IsA("TextLabel") or child:IsA("TextButton") then
            TweenService:Create(child, TweenInfo.new(0.15), {TextTransparency = 1}):Play()
        end
        if child:IsA("Frame") and child.BackgroundTransparency < 1 then
            TweenService:Create(child, TweenInfo.new(0.15), {BackgroundTransparency = 1}):Play()
        end
    end
    task.wait(0.15)
    ContentContainer.Visible = false
    local t = TweenService:Create(MainFrame, TweenInfo.new(0.2, Enum.EasingStyle.Quart, Enum.EasingDirection.In), {
        Size = UDim2.new(0, 480, 0, 0), Position = UDim2.new(0.5, -240, 0.5, 0), BackgroundTransparency = 1
    })
    TweenService:Create(MainStroke, TweenInfo.new(0.2), {Transparency = 1}):Play()
    t:Play()
    t.Completed:Connect(function()
        MainFrame.Visible = false
        MainFrame.Size = UDim2.new(0, 480, 0, 320)
        MainFrame.Position = UDim2.new(0.5, -240, 0.5, -160)
        MainFrame.BackgroundTransparency = 0
        MainStroke.Transparency = 0
        HUB_ANIMATION_PLAYING = false
        ShowKeybindInfo()
        if callback then callback() end
    end)
end

local function UpdateLoadingProgress(pct, status)
    LoadingPercent.Text = math.floor(pct) .. "%"
    if status then LoadingStatusText.Text = status end
    TweenService:Create(ProgressBarFill, TweenInfo.new(0.3), {Size = UDim2.new(pct/100, 0, 1, 0)}):Play()
end

local function StartLoadingAnimation()
    MainFrame.Size = UDim2.new(0, 480, 0, 320)
    MainFrame.Position = UDim2.new(0.5, -240, 0.5, -160)
    MainFrame.BackgroundTransparency = 1
    MainStroke.Transparency = 1
    LoadingOverlay.Visible = true
    ContentContainer.Visible = false
    MainFrame.Visible = true
    TweenService:Create(MainFrame, TweenInfo.new(0.4, Enum.EasingStyle.Quart, Enum.EasingDirection.Out), {BackgroundTransparency = 0}):Play()
    TweenService:Create(MainStroke, TweenInfo.new(0.4, Enum.EasingStyle.Quart, Enum.EasingDirection.Out), {Transparency = 0}):Play()
    task.wait(0.2)
    TweenService:Create(LoadingTitle, TweenInfo.new(0.3), {TextTransparency = 0}):Play()
    task.wait(0.1)
    TweenService:Create(LoadingSubtitle, TweenInfo.new(0.3), {TextTransparency = 0}):Play()
    task.wait(0.1)
    TweenService:Create(ProgressBarBg, TweenInfo.new(0.3), {BackgroundTransparency = 0}):Play()
    TweenService:Create(ProgressBarBgStroke, TweenInfo.new(0.3), {Transparency = 0}):Play()
    TweenService:Create(LoadingStatusText, TweenInfo.new(0.3), {TextTransparency = 0}):Play()
    TweenService:Create(LoadingPercent, TweenInfo.new(0.3), {TextTransparency = 0}):Play()
end

local function EndLoadingAnimation(callback)
    LoadingStatusText.Text = "Loading Complete!"
    LoadingStatusText.TextColor3 = Color3.fromRGB(100, 255, 100)
    task.wait(0.6)
    for _, v in ipairs({LoadingTitle, LoadingSubtitle, ProgressBarBg, ProgressBarBgStroke, ProgressBarFill, LoadingStatusText, LoadingPercent}) do
        local prop = v:IsA("UIStroke") and "Transparency" or (v:IsA("Frame") and "BackgroundTransparency" or "TextTransparency")
        TweenService:Create(v, TweenInfo.new(0.3), {[prop] = 1}):Play()
    end
    task.wait(0.4)
    LoadingOverlay.Visible = false
    ContentContainer.Visible = true
    FadeContentIn()
    task.wait(0.3)
    LOADING_COMPLETE = true
    if callback then callback() end
end

-- ============================================
-- NO RECOIL
-- [FIX] 모든 require를 SafeRequire로 교체
-- ============================================
local nrGunModule, nrItemLibrary = nil, nil
local nrOriginalRecoil, nrOriginalStartShooting, nrOriginal_LocalTracers = nil, nil, nil

local function initNoRecoilModules()
    task.spawn(function()  -- [FIX] task.spawn으로 비동기 처리
        local PlayerScripts = SafeWait(LocalPlayer, "PlayerScripts", 5)
        if not PlayerScripts then return end
        for _, module in pairs(PlayerScripts:GetDescendants()) do
            if module:IsA("ModuleScript") and module.Name == "Gun" then
                nrGunModule = SafeRequire(module)
                if nrGunModule then
                    nrOriginalRecoil = nrGunModule._Recoil
                    nrOriginalStartShooting = nrGunModule.StartShooting
                    nrOriginal_LocalTracers = nrGunModule._LocalTracers
                end
                break
            end
        end
        local mods = ReplicatedStorage:FindFirstChild("Modules")
        if mods then
            local lib = mods:FindFirstChild("ItemLibrary")
            if lib then nrItemLibrary = SafeRequire(lib) end
        end
    end)
end

local function enableNoRecoil()
    if not nrGunModule then
        createNotification("NoRecoil: Module not ready")
        return
    end
    pcall(function()
        nrGunModule._Recoil = function() end
        nrGunModule.StartShooting = function(self, a2, a3)
            local ok, e, cd, ia, x1, x2 = nrOriginalStartShooting(self, a2, a3)
            return ok, e, cd, true, x1, x2
        end
        nrGunModule._LocalTracers = function(self, _, a3)
            return nrOriginal_LocalTracers(self, true, a3)
        end
        if nrItemLibrary and nrItemLibrary.Items then
            for _, wd in pairs(nrItemLibrary.Items) do
                if wd.Type == "Gun" then wd.ShootRecoil = 0 wd.AimSpreadMultiplier = 0 end
            end
        end
    end)
    createNotification("No Recoil Enabled")
end

local function disableNoRecoil()
    if nrGunModule and nrOriginalRecoil then
        pcall(function()
            nrGunModule._Recoil = nrOriginalRecoil
            nrGunModule.StartShooting = nrOriginalStartShooting
            nrGunModule._LocalTracers = nrOriginal_LocalTracers
        end)
    end
    createNotification("No Recoil Disabled")
end

-- ============================================
-- THIRD PERSON
-- ============================================
local thirdPersonConnection = nil
local thirdPersonWheelConnection = nil
local distance = 12
local heightOffset = 2.5
local sideOffset = 0

local function updateThirdPersonCamera()
    local char = LocalPlayer.Character
    if char and char:FindFirstChild("HumanoidRootPart") then
        local root = char.HumanoidRootPart
        local rot = Camera.CFrame.Rotation
        local tgt = root.Position + Vector3.new(0, heightOffset, 0)
        Camera.CFrame = rot + (tgt + rot * Vector3.new(sideOffset, 0, distance))
        for _, p in pairs(char:GetChildren()) do
            if p:IsA("BasePart") then p.LocalTransparencyModifier = 0 end
        end
    end
end

local function enableThirdPerson()
    if thirdPersonConnection then thirdPersonConnection:Disconnect() end
    if thirdPersonWheelConnection then thirdPersonWheelConnection:Disconnect() end
    RunService:UnbindFromRenderStep("ThirdPersonCamera")
    RunService:BindToRenderStep("ThirdPersonCamera", Enum.RenderPriority.Camera.Value + 1, updateThirdPersonCamera)
    thirdPersonConnection = true
    thirdPersonWheelConnection = UserInputService.InputChanged:Connect(function(input)
        if THIRD_PERSON_ENABLED and input.UserInputType == Enum.UserInputType.MouseWheel then
            distance = math.clamp(distance - (input.Position.Z * 1.5), 3, 30)
        end
    end)
    createNotification("Third Person Enabled")
end

local function disableThirdPerson()
    RunService:UnbindFromRenderStep("ThirdPersonCamera")
    thirdPersonConnection = nil
    if thirdPersonWheelConnection then thirdPersonWheelConnection:Disconnect() thirdPersonWheelConnection = nil end
    Camera.CameraType = Enum.CameraType.Custom
    distance = 12
    createNotification("Third Person Disabled")
end

-- ============================================
-- NO COOL TIME
-- [FIX] WaitForChild 타임아웃 추가 + SafeRequire 사용
-- ============================================
local weaponDataCache = nil
local lastCooldownRemoval = 0
local noCoolTimeApplied = false

local function removeCooldowns()
    local now = tick()
    if now - lastCooldownRemoval < 10 then return end
    task.spawn(function()  -- [FIX] 비동기 처리
        local ok, result = pcall(function()
            if not weaponDataCache then
                local mods = ReplicatedStorage:FindFirstChild("Modules")
                if not mods then return false end
                local names = {"ItemLibrary","WeaponStats","Items","WeaponData","Weapons"}
                local wm = nil
                for _, n in ipairs(names) do
                    wm = mods:FindFirstChild(n)
                    if wm then break end
                end
                if not wm then return false end
                weaponDataCache = SafeRequire(wm)
                if not weaponDataCache then return false end
            end
            if not weaponDataCache.Items then return false end
            for _, s in pairs(weaponDataCache.Items) do
                for _, k in ipairs({"ShootCooldown","ShootBurstCooldown","AttackCooldown","HeavyAttackCooldown",
                    "Cooldown","DeflectCooldown","DashCooldown","BuildCooldown","SpinCooldown",
                    "AirblastCooldown","QuickShotCooldown","TransitionCooldown"}) do
                    if s[k] then s[k] = 0 end
                end
                if s.ReloadTime then s.ReloadTime = 0.01 end
            end
            return true
        end)
        if ok and result then
            noCoolTimeApplied = true
            lastCooldownRemoval = now
        end
    end)
end

-- ============================================
-- RAGE BOT
-- ============================================
local rbEnabled = false
local rbTarget = nil
local rbConnection = nil
local rbChar, rbHrp, rbHum = nil, nil, nil

local function rbUpdateCharacterRefs()
    rbChar = LocalPlayer.Character
    if rbChar then
        rbHrp = rbChar:FindFirstChild("HumanoidRootPart")
        rbHum = rbChar:FindFirstChild("Humanoid")
    end
end

local function rbFindNearest()
    if not rbHrp then return nil end
    local nearest, minD = nil, math.huge
    for _, p in pairs(Players:GetPlayers()) do
        if p ~= LocalPlayer and p.Character and isEnemy(p) then
            local h = p.Character:FindFirstChild("HumanoidRootPart")
            local hm = p.Character:FindFirstChild("Humanoid")
            if h and hm and hm.Health > 0 then
                local d = (rbHrp.Position - h.Position).Magnitude
                if d < minD then minD = d; nearest = p end
            end
        end
    end
    return nearest
end

local function rbMainLoop()
    if not rbEnabled then return end
    rbTarget = rbFindNearest()
    if rbTarget and rbTarget.Character and rbHrp then
        local th = rbTarget.Character:FindFirstChild("HumanoidRootPart")
        local thm = rbTarget.Character:FindFirstChild("Humanoid")
        if th and thm and thm.Health > 0 then
            local tp = th.Position + Vector3.new(math.random(-8,8), math.random(6,12), math.random(-8,8))
            rbHrp.CFrame = CFrame.new(tp)
            local t = tick() * 25
            rbHrp.CFrame = rbHrp.CFrame * CFrame.Angles(math.rad(math.sin(t*3.7)*360), math.rad(math.cos(t*4.3)*360), math.rad(math.sin(t*5.1)*360))
            rbHrp.Velocity = Vector3.new(math.random(-50,50), math.random(-50,50), math.random(-50,50))
        end
    end
end

LocalPlayer.CharacterAdded:Connect(function()
    if rbEnabled then rbEnabled = false; if rbConnection then rbConnection:Disconnect() rbConnection = nil end end
    rbUpdateCharacterRefs()
end)

-- ============================================
-- FULL AUTO
-- ============================================
local faTargetPlayer = nil
local faIsAbove = false
local faLastHealth = 100
local faSpinConnection = nil
local faAutoClickConnection = nil
local faCameraConnection = nil
local faIsFirstTeleport = true
local faLoopActive = false
local faLastAutoClickTime = 0
local faAutoClickPaused = false
local faGravityConnection = nil
local faLastRetreatTime = 0
local faIsRetreating = false
local faRetreatLock = false

local function faFindClosest()
    local char = LocalPlayer.Character
    if not char or not char:FindFirstChild("HumanoidRootPart") then return nil end
    local myPos = char.HumanoidRootPart.Position
    local closest, minD = nil, math.huge
    for _, p in pairs(Players:GetPlayers()) do
        if p ~= LocalPlayer and p.Character and isEnemy(p) then
            local r = p.Character:FindFirstChild("HumanoidRootPart")
            if r then
                local d = (myPos - r.Position).Magnitude
                if d < minD then minD = d; closest = p end
            end
        end
    end
    return closest
end

local function faPressR()
    VirtualInputManager:SendKeyEvent(true, Enum.KeyCode.R, false, game)
    task.wait(0.05)
    VirtualInputManager:SendKeyEvent(false, Enum.KeyCode.R, false, game)
end

local function faDisableGravity()
    if faGravityConnection then faGravityConnection:Disconnect() end
    faGravityConnection = RunService.RenderStepped:Connect(function()
        if not FULL_AUTO_ENABLED then
            if faGravityConnection then faGravityConnection:Disconnect() faGravityConnection = nil end
            return
        end
        local char = LocalPlayer.Character
        local root = char and char:FindFirstChild("HumanoidRootPart")
        if root and not root:FindFirstChild("FA_NoGravity") then
            local bv = Instance.new("BodyVelocity")
            bv.Name = "FA_NoGravity"
            bv.MaxForce = Vector3.new(0, math.huge, 0)
            bv.Velocity = Vector3.zero
            bv.Parent = root
        end
    end)
end

local function faEnableGravity()
    if faGravityConnection then faGravityConnection:Disconnect() faGravityConnection = nil end
    local char = LocalPlayer.Character
    local root = char and char:FindFirstChild("HumanoidRootPart")
    if root then
        local bv = root:FindFirstChild("FA_NoGravity")
        if bv then bv:Destroy() end
    end
end

local function faStartSpinning()
    if faSpinConnection then faSpinConnection:Disconnect() end
    faSpinConnection = RunService.RenderStepped:Connect(function()
        if not FULL_AUTO_ENABLED then
            if faSpinConnection then faSpinConnection:Disconnect() faSpinConnection = nil end
            return
        end
        if faIsRetreating then return end
        local char = LocalPlayer.Character
        local root = char and char:FindFirstChild("HumanoidRootPart")
        if root then
            root.CFrame = root.CFrame * CFrame.Angles(math.rad(math.random(-30,30)), math.rad(math.random(0,360)), math.rad(math.random(-30,30)))
        end
    end)
end

local function faStartCameraLock()
    if faCameraConnection then faCameraConnection:Disconnect() end
    faCameraConnection = RunService.RenderStepped:Connect(function()
        if not FULL_AUTO_ENABLED then
            Camera.CameraType = Enum.CameraType.Custom
            if faCameraConnection then faCameraConnection:Disconnect() faCameraConnection = nil end
            return
        end
        if faIsRetreating then return end
        local char = LocalPlayer.Character
        local myRoot = char and char:FindFirstChild("HumanoidRootPart")
        if faTargetPlayer and faTargetPlayer.Character and myRoot then
            local head = faTargetPlayer.Character:FindFirstChild("Head")
            if head then
                Camera.CameraType = Enum.CameraType.Scriptable
                Camera.CFrame = CFrame.new(myRoot.Position + Vector3.new(0,5,0), head.Position)
            end
        end
    end)
end

local function faInRange()
    if not faTargetPlayer or not faTargetPlayer.Character then return false end
    local char = LocalPlayer.Character
    local myRoot = char and char:FindFirstChild("HumanoidRootPart")
    local tRoot = faTargetPlayer.Character:FindFirstChild("HumanoidRootPart")
    if not myRoot or not tRoot then return false end
    local d = (myRoot.Position - tRoot.Position).Magnitude
    return d <= 30 and math.abs(myRoot.Position.Y - tRoot.Position.Y) <= 25
end

local function faStartAutoClick()
    if faAutoClickConnection then faAutoClickConnection:Disconnect() end
    faAutoClickConnection = RunService.RenderStepped:Connect(function()
        if not FULL_AUTO_ENABLED then
            if faAutoClickConnection then faAutoClickConnection:Disconnect() faAutoClickConnection = nil end
            return
        end
        if faAutoClickPaused or faIsRetreating or MainFrame.Visible then return end
        if not faInRange() then return end
        local now = tick()
        if now - faLastAutoClickTime >= 0.02 then
            faLastAutoClickTime = now
            pcall(mouse1click)
        end
    end)
end

local function faPerformRetreat(targetRoot)
    if faRetreatLock then return end
    faRetreatLock = true
    faIsRetreating = true
    faAutoClickPaused = true
    local char = LocalPlayer.Character
    local root = char and char:FindFirstChild("HumanoidRootPart")
    if not root or not targetRoot then
        faIsRetreating = false; faAutoClickPaused = false; faRetreatLock = false
        return
    end
    Camera.CameraType = Enum.CameraType.Custom
    root.CFrame = CFrame.new(targetRoot.Position + Vector3.new(0, 10000, 0))
    task.wait(0.2)
    faPressR()
    task.wait(2)
    faAutoClickPaused = false
    faIsRetreating = false
    faLastRetreatTime = tick()
    faIsAbove = false
    faRetreatLock = false
    local newHum = LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("Humanoid")
    if newHum then faLastHealth = newHum.Health end
end

local function faMainLoop()
    faLoopActive = true
    while FULL_AUTO_ENABLED do
        task.wait(0.1)
        if not FULL_AUTO_ENABLED then break end
        if not faTargetPlayer or not faTargetPlayer.Character then
            faTargetPlayer = faFindClosest()
            if not faTargetPlayer then task.wait(0.5); continue end
            local th = faTargetPlayer.Character:FindFirstChild("Humanoid")
            if th then faLastHealth = th.Health end
        end
        local char = LocalPlayer.Character
        local hum = char and char:FindFirstChild("Humanoid")
        local root = char and char:FindFirstChild("HumanoidRootPart")
        if not char or not hum or not root then task.wait(0.5); continue end
        local tChar = faTargetPlayer.Character
        local tRoot = tChar and tChar:FindFirstChild("HumanoidRootPart")
        local tHum = tChar and tChar:FindFirstChild("Humanoid")
        if not tRoot or not tHum then faTargetPlayer = nil; task.wait(0.5); continue end
        local curHP = hum.Health
        local now = tick()
        if not faRetreatLock then
            if curHP < faLastHealth and faLastHealth > 0 then
                faPerformRetreat(tRoot)
            elseif not faIsRetreating and (now - faLastRetreatTime >= 2.5) then
                faPerformRetreat(tRoot)
            elseif not faIsAbove and not faIsRetreating then
                root.CFrame = CFrame.new(tRoot.Position + Vector3.new(0, 10000, 0))
                task.wait(math.random(10,20)/10)
                faIsAbove = true
            elseif not faIsRetreating then
                root.CFrame = CFrame.new(tRoot.Position + Vector3.new(0, 15, 0))
                if faIsFirstTeleport then task.wait(2); faIsFirstTeleport = false end
                faLastHealth = curHP
            end
        end
    end
    faLoopActive = false
end

local function faStart()
    local char = LocalPlayer.Character
    local hum = char and char:FindFirstChild("Humanoid")
    faLastHealth = hum and hum.Health or 100
    faIsFirstTeleport = true
    faTargetPlayer = nil
    faAutoClickPaused = false
    faIsRetreating = false
    faRetreatLock = false
    faLastRetreatTime = tick()
    faDisableGravity()
    faStartSpinning()
    faStartCameraLock()
    faStartAutoClick()
    if not faLoopActive then task.spawn(faMainLoop) end
end

local function faStop()
    if faSpinConnection then faSpinConnection:Disconnect() faSpinConnection = nil end
    if faCameraConnection then faCameraConnection:Disconnect() faCameraConnection = nil end
    if faAutoClickConnection then faAutoClickConnection:Disconnect() faAutoClickConnection = nil end
    faEnableGravity()
    Camera.CameraType = Enum.CameraType.Custom
    faLoopActive = false
end

LocalPlayer.CharacterAdded:Connect(function(char)
    if FULL_AUTO_ENABLED then
        task.wait(1)
        faStart()
    end
end)

-- ============================================
-- UI COMPONENTS
-- ============================================
local UIHandlers = {}

local function CreateToggle(name, parent, callback, configType, defaultValue)
    local container = Instance.new("Frame")
    container.Size = UDim2.new(1, 0, 0, 24)
    container.BackgroundTransparency = 1
    container.Parent = parent

    local box = Instance.new("TextButton")
    box.Size = UDim2.new(0, 14, 0, 14)
    box.Position = UDim2.new(0, 5, 0.5, -7)
    box.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
    box.Text = ""
    box.BorderSizePixel = 0
    box.Parent = container

    local boxStroke = Instance.new("UIStroke")
    boxStroke.Color = Color3.fromRGB(255, 255, 255)
    boxStroke.Thickness = 1
    boxStroke.ApplyStrokeMode = Enum.ApplyStrokeMode.Border
    boxStroke.Parent = box

    local checkInner = Instance.new("Frame")
    checkInner.Name = "CheckInner"
    checkInner.Size = UDim2.new(1, -4, 1, -4)
    checkInner.Position = UDim2.new(0, 2, 0, 2)
    checkInner.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
    checkInner.Visible = (defaultValue == true)
    checkInner.BorderSizePixel = 0
    checkInner.Parent = box
    table.insert(ToggleCheckInners, checkInner)

    local label = Instance.new("TextButton")
    label.Size = UDim2.new(1, -100, 1, 0)
    label.Position = UDim2.new(0, 30, 0, 0)
    label.BackgroundTransparency = 1
    label.Text = name
    label.Font = Enum.Font.Code
    label.TextColor3 = Color3.fromRGB(255, 255, 255)
    label.TextSize = 13
    label.TextXAlignment = Enum.TextXAlignment.Left
    label.Parent = container

    local enabled = defaultValue or false
    local function setEnabled(val)
        enabled = val
        checkInner.Visible = val
        if callback then callback(val) end
        saveConfig()
    end
    box.MouseButton1Click:Connect(function() setEnabled(not enabled) end)
    label.MouseButton1Click:Connect(function() setEnabled(not enabled) end)

    if configType then
        local configBtn = Instance.new("TextButton")
        configBtn.Size = UDim2.new(0, 60, 0, 18)
        configBtn.Position = UDim2.new(1, -65, 0.5, -9)
        configBtn.BackgroundColor3 = Color3.fromRGB(15, 15, 15)
        configBtn.Font = Enum.Font.Code
        configBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
        configBtn.TextSize = 11
        configBtn.BorderSizePixel = 0
        configBtn.Parent = container
        local cs = Instance.new("UIStroke")
        cs.Color = Color3.fromRGB(255, 255, 255)
        cs.Thickness = 1
        cs.ApplyStrokeMode = Enum.ApplyStrokeMode.Border
        cs.Parent = configBtn

        if configType == "Keybind" then
            configBtn.Text = "[" .. formatKeyName(AIM_LOCK_KEY) .. "]"
            configBtn.MouseButton1Click:Connect(function()
                configBtn.Text = "..."
                local conn
                conn = UserInputService.InputBegan:Connect(function(input)
                    local nb = input.UserInputType == Enum.UserInputType.Keyboard and input.KeyCode or input.UserInputType
                    if nb ~= Enum.UserInputType.MouseMovement then
                        AIM_LOCK_KEY = nb
                        configBtn.Text = "[" .. formatKeyName(nb) .. "]"
                        UpdateKeybindInfo(); saveConfig(); conn:Disconnect()
                    end
                end)
            end)
        elseif configType == "RageBotKeybind" then
            configBtn.Text = "[" .. formatKeyName(RAGE_BOT_KEY) .. "]"
            configBtn.MouseButton1Click:Connect(function()
                configBtn.Text = "..."
                local conn
                conn = UserInputService.InputBegan:Connect(function(input)
                    if input.UserInputType == Enum.UserInputType.Keyboard then
                        RAGE_BOT_KEY = input.KeyCode
                        configBtn.Text = "[" .. formatKeyName(input.KeyCode) .. "]"
                        UpdateKeybindInfo(); saveConfig(); conn:Disconnect()
                    end
                end)
            end)
        elseif configType == "AimMode" then
            configBtn.Text = AUTO_AIM_MODE
            configBtn.MouseButton1Click:Connect(function()
                AUTO_AIM_MODE = (AUTO_AIM_MODE == "Silent") and "Aim" or "Silent"
                configBtn.Text = AUTO_AIM_MODE
                saveConfig()
            end)
        elseif configType == "MatchMode" then
            configBtn.Text = AUTO_MATCH_MODE
            local modes = {"1v1","2v2","3v3","4v4","5v5"}
            configBtn.MouseButton1Click:Connect(function()
                local ci = 1
                for i, m in ipairs(modes) do if m == AUTO_MATCH_MODE then ci = i break end end
                AUTO_MATCH_MODE = modes[(ci % #modes) + 1]
                configBtn.Text = AUTO_MATCH_MODE
                saveConfig()
            end)
        end
    end
    return setEnabled
end

local function CreateButton(name, parent, callback)
    local btn = Instance.new("TextButton")
    btn.Size = UDim2.new(0, 140, 0, 26)
    btn.BackgroundColor3 = Color3.fromRGB(15, 15, 15)
    btn.Text = name
    btn.Font = Enum.Font.Code
    btn.TextColor3 = Color3.fromRGB(255, 255, 255)
    btn.TextSize = 13
    btn.BorderSizePixel = 0
    btn.Parent = parent
    local s = Instance.new("UIStroke")
    s.Color = Color3.fromRGB(255, 255, 255)
    s.Thickness = 1
    s.ApplyStrokeMode = Enum.ApplyStrokeMode.Border
    s.Parent = btn
    btn.MouseButton1Click:Connect(callback)
end

-- ============================================
-- [FIX] Auto Match: WaitForChild에 타임아웃 적용
-- ============================================
local function attemptJoinMatch()
    if not AUTO_MATCH_ENABLED then return end
    task.spawn(function()  -- [FIX] 비동기 처리
        pcall(function()
            local remotes = SafeWait(ReplicatedStorage, "Remotes", 3)
            if not remotes then return end
            local mm = SafeWait(remotes, "Matchmaking", 3)
            if not mm then return end
            local jq = SafeWait(mm, "JoinQueue", 3)
            if not jq then return end
            jq:InvokeServer(AUTO_MATCH_MODE)
        end)
    end)
end

task.spawn(function()
    while task.wait(1) do
        if AUTO_MATCH_ENABLED then attemptJoinMatch() end
    end
end)

local function setupPlayerTracking(p)
    if p == LocalPlayer then return end
    p.CharacterAdded:Connect(function(char)
        local hum = char:WaitForChild("Humanoid", 10)
        if not hum then return end
        local lastH = hum.Health
        hum.HealthChanged:Connect(function(h)
            if not NOTIFICATION_ENABLED or not isEnemy(p) then return end
            local diff = h - lastH
            if diff < 0 then createNotification(string.format("Hit %s -%d", p.Name, math.floor(-diff)))
            elseif diff > 0 then createNotification(string.format("Healing %s +%d", p.Name, math.floor(diff))) end
            lastH = h
        end)
        hum.Died:Connect(function()
            if NOTIFICATION_ENABLED and isEnemy(p) then createNotification("Killed " .. p.Name) end
        end)
    end)
end

local function getClosestPlayer()
    local closest, minD = nil, math.huge
    for _, p in pairs(Players:GetPlayers()) do
        if p ~= LocalPlayer and isEnemy(p) and p.Character then
            local head = p.Character:FindFirstChild("Head")
            local hum = p.Character:FindFirstChild("Humanoid")
            if head and hum and hum.Health > 0 then
                local _, onScreen = Camera:WorldToScreenPoint(head.Position)
                if onScreen and LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart") then
                    local d = (LocalPlayer.Character.HumanoidRootPart.Position - head.Position).Magnitude
                    if d < minD then minD = d; closest = p end
                end
            end
        end
    end
    return closest
end

local function updateAimLock()
    if not isAimLockHeld or not AIM_LOCK_ENABLED then return end
    local t = getClosestPlayer()
    if t and t.Character and t.Character:FindFirstChild("Head") then
        local pos = Camera:WorldToScreenPoint(t.Character.Head.Position)
        pcall(function() mousemoverel(math.floor(pos.X - Mouse.X + 0.5), math.floor(pos.Y - Mouse.Y + 0.5)) end)
    end
end

-- INPUT
UserInputService.InputBegan:Connect(function(i, gpe)
    if gpe then return end
    if AIM_LOCK_ENABLED and (i.KeyCode == AIM_LOCK_KEY or i.UserInputType == AIM_LOCK_KEY) then
        isAimLockHeld = true
        if aimLockConnection then aimLockConnection:Disconnect() end
        aimLockConnection = RunService.RenderStepped:Connect(updateAimLock)
    end
    if RAGE_BOT_ENABLED and i.KeyCode == RAGE_BOT_KEY then
        rbEnabled = not rbEnabled
        if rbEnabled then
            rbUpdateCharacterRefs()
            if rbConnection then rbConnection:Disconnect() end
            rbConnection = RunService.Heartbeat:Connect(rbMainLoop)
            createNotification("Rage Bot Activated!")
        else
            if rbConnection then rbConnection:Disconnect() rbConnection = nil end
            if rbHrp then rbHrp.Velocity = Vector3.zero end
            createNotification("Rage Bot Deactivated!")
        end
    end
    if not HUB_ANIMATION_PLAYING and i.KeyCode == Enum.KeyCode.K and LOADING_COMPLETE then
        if MainFrame.Visible then AnimateHubClose() else AnimateHubOpen() end
    end
end)

UserInputService.InputEnded:Connect(function(i)
    if i.KeyCode == AIM_LOCK_KEY or i.UserInputType == AIM_LOCK_KEY then
        isAimLockHeld = false
        if aimLockConnection then aimLockConnection:Disconnect() aimLockConnection = nil end
    end
end)

RunService.RenderStepped:Connect(function()
    if not AUTO_AIM_ENABLED or MainFrame.Visible then return end
    local found = false
    if AUTO_AIM_MODE == "Silent" then
        found = getClosestPlayerForSilentAim() ~= nil
    else
        local tgt = Mouse.Target
        if tgt and tgt.Parent then
            local p = Players:GetPlayerFromCharacter(tgt.Parent) or Players:GetPlayerFromCharacter(tgt.Parent.Parent)
            if p and p ~= LocalPlayer and isEnemy(p) and p.Character then
                local hum = p.Character:FindFirstChild("Humanoid")
                found = hum and hum.Health > 0 or false
            end
        end
    end
    if found then
        local now = tick()
        if now - lastClickTime >= CLICK_INTERVAL then
            lastClickTime = now
            pcall(function()
                VirtualInputManager:SendMouseButtonEvent(Mouse.X, Mouse.Y, 0, true, game, 0)
                task.wait(0.01)
                VirtualInputManager:SendMouseButtonEvent(Mouse.X, Mouse.Y, 0, false, game, 0)
            end)
        end
    end
end)

local function updateESPStates()
    for _, p in pairs(Players:GetPlayers()) do
        local r = p.Character and p.Character:FindFirstChild("HumanoidRootPart")
        if r then
            local g = r:FindFirstChild("ESP_Gui")
            if g then g.Enabled = ESP_ENABLED and isEnemy(p) end
            local h = r:FindFirstChild("HealthESP_Gui")
            if h then h.Enabled = HP_BAR_ENABLED and isEnemy(p) end
        end
    end
end

local function createESP(player)
    if player == LocalPlayer then return end
    local function onChar(char)
        local root = char:WaitForChild("HumanoidRootPart", 5)
        local hum = char:WaitForChild("Humanoid", 5)
        if not root or not hum then return end
        local bGui = Instance.new("BillboardGui", root)
        bGui.Name = "ESP_Gui"
        bGui.Size = UDim2.new(4, 0, 5.5, 0)
        bGui.AlwaysOnTop = true
        bGui.Enabled = ESP_ENABLED and isEnemy(player)
        local container = Instance.new("Frame", bGui)
        container.Size = UDim2.new(1, 0, 1, 0)
        container.BackgroundTransparency = 1
        local function line(s, p)
            local ol = Instance.new("Frame", container)
            ol.BackgroundColor3 = Color3.new(0,0,0)
            ol.BorderSizePixel = 0
            ol.Size = UDim2.new(s.X.Scale, s.X.Offset+2, s.Y.Scale, s.Y.Offset+2)
            ol.Position = UDim2.new(p.X.Scale, p.X.Offset-1, p.Y.Scale, p.Y.Offset-1)
            ol.ZIndex = 1
            local f = Instance.new("Frame", container)
            f.BackgroundColor3 = Color3.new(1,1,1)
            f.BorderSizePixel = 0
            f.Size = s; f.Position = p; f.ZIndex = 2
        end
        line(UDim2.new(1,0,0,1), UDim2.new(0,0,0,0))
        line(UDim2.new(1,0,0,1), UDim2.new(0,0,1,-1))
        line(UDim2.new(0,1,1,0), UDim2.new(0,0,0,0))
        line(UDim2.new(0,1,1,0), UDim2.new(1,-1,0,0))
        local hGui = Instance.new("BillboardGui", root)
        hGui.Name = "HealthESP_Gui"
        hGui.Size = UDim2.new(1,0,5.5,0)
        hGui.StudsOffset = Vector3.new(3,0,0)
        hGui.AlwaysOnTop = true
        hGui.Enabled = HP_BAR_ENABLED and isEnemy(player)
        local bg = Instance.new("Frame", hGui)
        bg.Size = UDim2.new(0.2,0,1,0)
        bg.BackgroundColor3 = Color3.fromRGB(50,50,50)
        bg.BorderSizePixel = 0
        local fill = Instance.new("Frame", bg)
        fill.Size = UDim2.new(1,0,1,0)
        fill.Position = UDim2.new(0,0,1,0)
        fill.AnchorPoint = Vector2.new(0,1)
        fill.BackgroundColor3 = Color3.fromRGB(0,255,0)
        fill.BorderSizePixel = 0
        local txt = Instance.new("TextLabel", bg)
        txt.Size = UDim2.new(3,0,0.2,0)
        txt.Position = UDim2.new(1.2,0,0,0)
        txt.BackgroundTransparency = 1
        txt.TextColor3 = Color3.new(1,1,1)
        txt.TextScaled = true
        txt.Font = Enum.Font.SourceSansBold
        local function update()
            local pct = math.clamp(hum.Health / hum.MaxHealth, 0, 1)
            fill.Size = UDim2.new(1,0,pct,0)
            fill.BackgroundColor3 = Color3.fromHSV(pct*0.3,1,1)
            txt.Text = math.floor(hum.Health).."/"..math.floor(hum.MaxHealth)
        end
        hum.HealthChanged:Connect(update); update()
    end
    player.CharacterAdded:Connect(onChar)
    if player.Character then onChar(player.Character) end
end

-- ============================================
-- TOGGLE REGISTRATIONS
-- ============================================
UIHandlers.UpdateSilentAim = CreateToggle("enabled (silent aim)", AimPage, function(v) SILENT_AIM_ENABLED = v end, nil, SILENT_AIM_ENABLED)
UIHandlers.UpdateAimLock = CreateToggle("Aim Lock", AimPage, function(v)
    AIM_LOCK_ENABLED = v; UpdateKeybindInfo()
end, "Keybind", AIM_LOCK_ENABLED)

UIHandlers.UpdateAutoAim = CreateToggle("Auto Aim", AimPage, function(v)
    AUTO_AIM_ENABLED = v
end, "AimMode", AUTO_AIM_ENABLED)

UIHandlers.UpdateAutoMatch = CreateToggle("Auto Match", AimPage, function(v)
    AUTO_MATCH_ENABLED = v
    if v then attemptJoinMatch() end
end, "MatchMode", AUTO_MATCH_ENABLED)

UIHandlers.UpdateFullAuto = CreateToggle("full Auto", AimPage, function(v)
    FULL_AUTO_ENABLED = v
    if v then faStart(); createNotification("Full Auto Started")
    else faStop(); createNotification("Full Auto Stopped") end
end, nil, FULL_AUTO_ENABLED)

UIHandlers.UpdateNoCoolTime = CreateToggle("No Cool Time (All)", AimPage, function(v)
    NO_COOL_TIME_ENABLED = v
    if v then
        lastCooldownRemoval = 0; removeCooldowns()
        task.spawn(function()
            while NO_COOL_TIME_ENABLED do task.wait(10); if NO_COOL_TIME_ENABLED then removeCooldowns() end end
        end)
        createNotification("No Cool Time Enabled")
    else
        weaponDataCache = nil; createNotification("No Cool Time Disabled")
    end
end, nil, NO_COOL_TIME_ENABLED)

UIHandlers.UpdateRageBot = CreateToggle("Rage bot", AimPage, function(v)
    RAGE_BOT_ENABLED = v; UpdateKeybindInfo()
    if v then
        rbUpdateCharacterRefs()
        createNotification("Rage Bot Ready! Press [" .. formatKeyName(RAGE_BOT_KEY) .. "]")
    else
        rbEnabled = false
        if rbConnection then rbConnection:Disconnect() rbConnection = nil end
        if rbHrp then rbHrp.Velocity = Vector3.zero end
        createNotification("Rage Bot Disabled")
    end
end, "RageBotKeybind", RAGE_BOT_ENABLED)

CreateToggle("No spread,recoil", AimPage, function(v)
    NO_RECOIL_ENABLED = v
    if v then
        if not nrGunModule then initNoRecoilModules() end
        task.delay(0.5, function() if NO_RECOIL_ENABLED then enableNoRecoil() end end)
    else disableNoRecoil() end
end, nil, NO_RECOIL_ENABLED)

CreateToggle("enabled (esp)", VisualPage, function(v) ESP_ENABLED = v; updateESPStates() end, nil, ESP_ENABLED)
CreateToggle("HP bar", VisualPage, function(v) HP_BAR_ENABLED = v; updateESPStates() end, nil, HP_BAR_ENABLED)
CreateToggle("Notification", VisualPage, function(v) NOTIFICATION_ENABLED = v end, nil, NOTIFICATION_ENABLED)
CreateToggle("third person", VisualPage, function(v)
    THIRD_PERSON_ENABLED = v
    if v then enableThirdPerson() else disableThirdPerson() end
end, nil, THIRD_PERSON_ENABLED)

CreateToggle("Load skin changer", VisualPage, function(v)
    SKIN_CHANGER_ENABLED = v
    if v then
        task.spawn(function()  -- [FIX] 비동기 처리
            local ok = pcall(function()
                loadstring(game:HttpGet("https://raw.githubusercontent.com/kgycoder/Rivals-Skin-changer/refs/heads/main/Rivals-Skin%20changer", true))()
            end)
            createNotification(ok and "Skin Changer Loaded" or "Skin Changer Failed")
        end)
    else createNotification("Skin Changer Disabled") end
end, nil, SKIN_CHANGER_ENABLED)

CreateButton("mesh wrapping", VisualPage, function()
    local VM = workspace:FindFirstChild("ViewModels")
    local FP = VM and VM:FindFirstChild("FirstPerson")
    if FP then
        for _, o in ipairs(FP:GetDescendants()) do
            if o:IsA("MeshPart") then
                o.Material = Enum.Material.ForceField
                o.Color = Color3.new(0,0,0)
                for _, f in ipairs({Enum.NormalId.Top, Enum.NormalId.Bottom, Enum.NormalId.Left, Enum.NormalId.Right, Enum.NormalId.Front, Enum.NormalId.Back}) do
                    local t = o:FindFirstChild("FixedTexture_"..f.Name) or Instance.new("Texture", o)
                    t.Name = "FixedTexture_"..f.Name
                    t.Texture = "rbxassetid://135989547473439"
                    t.Face = f; t.Color3 = Color3.new(0,0,0)
                    t.StudsPerTileU = 0.1; t.StudsPerTileV = 0.1
                end
            end
        end
    end
end)

-- DRAG
local dragging, dragStart, startPos
MainFrame.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 and LOADING_COMPLETE then
        dragging = true; dragStart = input.Position; startPos = MainFrame.Position
    end
end)
UserInputService.InputChanged:Connect(function(input)
    if dragging and input.UserInputType == Enum.UserInputType.MouseMovement then
        local d = input.Position - dragStart
        MainFrame.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + d.X, startPos.Y.Scale, startPos.Y.Offset + d.Y)
    end
end)
UserInputService.InputEnded:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then dragging = false end
end)

CloseBtn.MouseButton1Click:Connect(function()
    if MainFrame.Visible then AnimateHubClose() else AnimateHubOpen() end
end)

-- ============================================
-- LOADING SEQUENCE
-- ============================================
local function RunLoadingSequence()
    StartLoadingAnimation()
    task.wait(0.5)
    UpdateLoadingProgress(10, "Checking Services...")
    task.wait(0.2)
    UpdateLoadingProgress(20, "Waiting for Character...")
    -- [FIX] 캐릭터 대기를 루프로 처리 (WaitForChild 무한 대기 방지)
    for i = 1, 40 do
        local char = LocalPlayer.Character
        if char and char:FindFirstChild("HumanoidRootPart") then break end
        task.wait(0.1)
    end
    UpdateLoadingProgress(30, "Setting up ESP...")
    for _, p in pairs(Players:GetPlayers()) do pcall(function() createESP(p) end) end
    Players.PlayerAdded:Connect(createESP)
    UpdateLoadingProgress(45, "Player Tracking...")
    for _, p in ipairs(Players:GetPlayers()) do pcall(function() setupPlayerTracking(p) end) end
    Players.PlayerAdded:Connect(setupPlayerTracking)
    UpdateLoadingProgress(60, "Loading Weapon Modules...")
    if NO_RECOIL_ENABLED then initNoRecoilModules() end
    if NO_COOL_TIME_ENABLED then
        lastCooldownRemoval = 0; removeCooldowns()
        task.spawn(function()
            while NO_COOL_TIME_ENABLED do task.wait(10); if NO_COOL_TIME_ENABLED then removeCooldowns() end end
        end)
    end
    UpdateLoadingProgress(75, "Loading External Scripts...")
    if SKIN_CHANGER_ENABLED then
        task.spawn(function()
            pcall(function()
                loadstring(game:HttpGet("https://raw.githubusercontent.com/kgycoder/Rivals-Skin-changer/refs/heads/main/Rivals-Skin%20changer", true))()
            end)
        end)
    end
    UpdateLoadingProgress(85, "Initializing Features...")
    if AUTO_MATCH_ENABLED then attemptJoinMatch() end
    if RAGE_BOT_ENABLED then rbUpdateCharacterRefs() end
    if THIRD_PERSON_ENABLED then pcall(enableThirdPerson) end
    updateESPStates()
    ShowTab("Aim")
    UpdateLoadingProgress(100, "All Systems Loaded!")
    task.wait(0.2)
    EndLoadingAnimation(function()
        task.wait(0.5)
        ShowKeybindInfo()
    end)
end

-- [FIX] 항상 로딩 시퀀스 실행 (FULL_AUTO 즉시실행 분기 제거)
task.spawn(RunLoadingSequence)
